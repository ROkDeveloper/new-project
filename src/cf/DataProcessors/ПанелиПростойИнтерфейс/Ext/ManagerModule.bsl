#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область СлужебныйПрограммныйИнтерфейс

Процедура ПолучитьДеревоПомеченныхНаУдалениеВФоне(Параметры, АдресРезультата) Экспорт
	
	КодПиктограммыСправочник = 4;
	КодПиктограммыДокумент = 13;
	
	ТекстЗапроса = "";
	
	РазделениеВключено = ОбщегоНазначения.РазделениеВключено();
	
	Для каждого Справочник Из Метаданные.Справочники Цикл
		Если РазделениеВключено И ЭтоОбщиеДанные(Справочник) Или Не ПравоДоступа("Чтение", Справочник) Тогда
			Продолжить;
		КонецЕсли;
		
		ЕстьГруппы = Справочник.Иерархический
			И Справочник.ВидИерархии = Метаданные.СвойстваОбъектов.ВидИерархии.ИерархияГруппИЭлементов;
		
		Если НЕ ПустаяСтрока(ТекстЗапроса) Тогда
			ТекстЗапроса = ТекстЗапроса + "
			|ОБЪЕДИНИТЬ ВСЕ
			|";
		КонецЕсли;
		
		ТекстЗапроса = ТекстЗапроса + СтрШаблон("ВЫБРАТЬ" + ?(ПустаяСтрока(ТекстЗапроса), " РАЗРЕШЕННЫЕ", "") + "
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(Справочник%1.Ссылка) КАК Представление,
		|	Справочник%1.Ссылка КАК Ссылка,
		|	%2 КАК НомерКартинки,
		|	""%3"" КАК ВидОбъекта
		|ИЗ
		|	Справочник.%1 КАК Справочник%1
		|ГДЕ
		|	Справочник%1.ПометкаУдаления" + ?(ЕстьГруппы, " И НЕ Справочник%1.ЭтоГруппа", ""),
		Справочник.Имя, КодПиктограммыСправочник, СтрЗаменить(Справочник.Представление(), """", """"""));
	КонецЦикла;
	
	Для каждого Документ Из Метаданные.Документы Цикл
		Если РазделениеВключено И ЭтоОбщиеДанные(Документ) Или Не ПравоДоступа("Чтение", Документ) Тогда
			Продолжить;
		КонецЕсли;
		
		Если НЕ ПустаяСтрока(ТекстЗапроса) Тогда
			ТекстЗапроса = ТекстЗапроса + "
			|ОБЪЕДИНИТЬ ВСЕ
			|";
		КонецЕсли;
		
		ТекстЗапроса = ТекстЗапроса + СтрШаблон("ВЫБРАТЬ ПРЕДСТАВЛЕНИЕССЫЛКИ(Документ%1.Ссылка) КАК Представление,
		|	Документ%1.Ссылка КАК Ссылка,
		|	%2 КАК НомерКартинки,
		|	""%3"" КАК ВидОбъекта
		|ИЗ
		|	Документ.%1 КАК Документ%1
		|ГДЕ
		|	Документ%1.ПометкаУдаления",
		Документ.Имя, КодПиктограммыСправочник, СтрЗаменить(Документ.Представление(), """", """"""));
	КонецЦикла;
	
	ТекстЗапроса = ТекстЗапроса + "
	|ИТОГИ ПО
	|	ВидОбъекта";
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	
	Дерево = Запрос.Выполнить().Выгрузить(ОбходРезультатаЗапроса.ПоГруппировкам);
	Для каждого Строка Из Дерево.Строки Цикл
		Строка.Представление = СтрШаблон("%1 (%2)", Строка.ВидОбъекта, Строка.Строки.Количество());
	КонецЦикла;
	Дерево.Строки.Сортировать("Представление", Истина);
	
	ПоместитьВоВременноеХранилище(Дерево, АдресРезультата);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Функция ЭтоОбщиеДанные(ЭлементМетаданных)
	
	ОбластьДанныхОсновныеДанные = Метаданные.ОбщиеРеквизиты.ОбластьДанныхОсновныеДанные.Состав.Найти(ЭлементМетаданных);
	Если ОбластьДанныхОсновныеДанные <> Неопределено
		И ОбластьДанныхОсновныеДанные.Использование = Метаданные.СвойстваОбъектов.ИспользованиеОбщегоРеквизита.НеИспользовать Тогда
		Возврат Истина;
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

#КонецОбласти

#КонецЕсли