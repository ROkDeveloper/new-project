#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда
 
////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	
	ЗаполнениеДокументов.Заполнить(ЭтотОбъект, ДанныеЗаполнения);
	
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	// ПОДГОТОВКА ПРОВЕДЕНИЯ ПО ДАННЫМ ДОКУМЕНТА
	
	ПроведениеСервер.ПодготовитьНаборыЗаписейКПроведению(ЭтотОбъект);
	
	ПараметрыПроведения = Документы.АвизоМПЗИсходящее.ПодготовитьПараметрыПроведения(Ссылка, Отказ);
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	// ПОДГОТОВКА ПРОВЕДЕНИЯ ПО ДАННЫМ ИНФОРМАЦИОННОЙ БАЗЫ
	
	
	// ФОРМИРОВАНИЕ ДВИЖЕНИЙ

	// Алгоритмы формирования проводок этого документа рассчитывают суммы проводок налогового учета
	Движения.Хозрасчетный.ДополнительныеСвойства.Вставить("СуммыНалоговогоУчетаЗаполнены", Истина);
	
	Документы.АвизоМПЗИсходящее.СформироватьДвиженияДанныеПоПартиям(
		ПараметрыПроведения.ТаблицаПоПартиям,
		ПараметрыПроведения.Реквизиты, Движения, Отказ);
		
	// Учет товаров по номерам ГТД
	Документы.АвизоМПЗИсходящее.СформироватьДвиженияСписанияПоСчетуГТД(
		ПараметрыПроведения.ТаблицаСписанияПоСчетуГТД, 
		ПараметрыПроведения.Реквизиты, Движения, Отказ);
		
	// Учет НДС
	Документы.АвизоМПЗИсходящее.СформироватьДвиженияПоРегистрамНДС(
		ПараметрыПроведения.ТаблицаПоСФ, ПараметрыПроведения.Реквизиты, Движения, Отказ); 
		
	// Регистрация в последовательности
	РаботаСПоследовательностями.ЗарегистрироватьОтложенныеРасчетыВПоследовательности(
		ЭтотОбъект, Отказ, , ПараметрыПроведения.ТаблицаРегистрации);
		
	ПроведениеСервер.УстановитьЗаписьОчищаемыхНаборовЗаписей(ЭтотОбъект);
		
КонецПроцедуры

Процедура ОбработкаПроверкиЗаполнения(Отказ, ПроверяемыеРеквизиты)

	//организация и получатель должны отличаться
	Если Организация = ОрганизацияПолучатель Тогда
		ТекстСообщения = НСтр("ru = 'Получатель должен отличаться от отправителя.'");
		ТекстСообщения = ОбщегоНазначенияКлиентСервер.ТекстОшибкиЗаполнения("Поле", "Корректность", 
																НСтр("ru = 'Получатель'"),,, ТекстСообщения);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, ЭтотОбъект, "ОрганизацияПолучатель", "Объект", Отказ);
	КонецЕсли;	
	
	РаздельныйУчетНДСНаСчете19 = УчетнаяПолитика.РаздельныйУчетНДСНаСчете19(Организация, Дата);
	
	МассивНепроверяемыхРеквизитов = Новый Массив();
	
	Если ПроверяемыеРеквизиты.Найти("Склад") = Неопределено Тогда
		ПроверяемыеРеквизиты.Добавить("Склад");
	КонецЕсли;

	// Проверять надо только по доп. условиям
    МассивНепроверяемыхРеквизитов.Добавить("ДанныеПоСФ.СчетФактура");
	МассивНепроверяемыхРеквизитов.Добавить("ДанныеПоСФ.СтавкаНДС");
	МассивНепроверяемыхРеквизитов.Добавить("Товары.НомерГТД");
	
	Для Каждого СтрокаТаблицы ИЗ ДанныеПоСФ Цикл
		
		НеЗаполненаСчетФактура 	= НЕ ЗначениеЗаполнено(СтрокаТаблицы.СчетФактура);
		НеЗаполненаСтавкаНДС	= НЕ ЗначениеЗаполнено(СтрокаТаблицы.СтавкаНДС);
		
		// В случаях, когда количество заполнено, сумма - не заполнена, и
		// 1. СтавкаНДС - БезНДС (случай передачи МПЗ по партии вида "Комплектация номенклатуры"
		// 2. СтавкаНДС - не заполнена (случай передачи МПЗ по партии вида "Оприходование товара", "Отчет производства за смену" и т.п.
		// то не нужно проверять заполненность счета-фактуры и ставки НДС
		Если СтрокаТаблицы.Количество <> 0 И СтрокаТаблицы.Стоимость = 0 И НЕ ЗначениеЗаполнено(СтрокаТаблицы.СчетФактура) 
			И (СтрокаТаблицы.СтавкаНДС = Перечисления.СтавкиНДС.БезНДС ИЛИ НЕ ЗначениеЗаполнено(СтрокаТаблицы.СтавкаНДС))
			Тогда
			НеЗаполненаСчетФактура 	= Ложь;
			НеЗаполненаСтавкаНДС 	= Ложь;
		КонецЕсли;                              
			
		Если НеЗаполненаСчетФактура Тогда
			
			Поле = "ДанныеПоСФ[" + Формат(СтрокаТаблицы.НомерСтроки - 1, "ЧН=0; ЧГ=") + "].СчетФактура";
			
			СвязаннаяНоменклатура = ДанныеПоПартиям.Найти(СтрокаТаблицы.Ключ, "Ключ").Номенклатура;
			ИмяСписка = НСтр("ru = 'Данные по счетам-фактурам номенклатуры ""%1""'");
			ИмяСписка = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ИмяСписка, СвязаннаяНоменклатура);
			
			ТекстСообщения = ОбщегоНазначенияКлиентСервер.ТекстОшибкиЗаполнения("Колонка",, 
				НСтр("ru = 'Счет-фактура (документ расчетов)'"), СтрокаТаблицы.НомерСтрокиТЧ, ИмяСписка);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, ЭтотОбъект, Поле, "Объект", Отказ);
			
		КонецЕсли;
		
		Если НеЗаполненаСтавкаНДС Тогда
			
			Поле = "ДанныеПоСФ[" + Формат(СтрокаТаблицы.НомерСтроки - 1, "ЧН=0; ЧГ=") + "].СтавкаНДС";
			
			СвязаннаяНоменклатура = ДанныеПоПартиям.Найти(СтрокаТаблицы.Ключ, "Ключ").Номенклатура;
			ИмяСписка = НСтр("ru = 'Данные по счетам-фактурам номенклатуры ""%1""'");
			ИмяСписка = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ИмяСписка, СвязаннаяНоменклатура);
			
			ТекстСообщения = ОбщегоНазначенияКлиентСервер.ТекстОшибкиЗаполнения("Колонка",, 
				НСтр("ru = 'Ставка НДС'"), СтрокаТаблицы.НомерСтрокиТЧ, ИмяСписка);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, ЭтотОбъект, Поле, "Объект", Отказ);
			
		КонецЕсли;
		
		//Проверка способа учета НДС
		Если РаздельныйУчетНДСНаСчете19 И НЕ ЗначениеЗаполнено(СтрокаТаблицы.СпособУчетаНДС)
			И СтрокаТаблицы.НДС <> 0 Тогда
			
			Поле = "ДанныеПоСФ[" + Формат(СтрокаТаблицы.НомерСтроки - 1, "ЧН=0; ЧГ=") + "].СпособУчетаНДС";
			
			СвязаннаяНоменклатура = ДанныеПоПартиям.Найти(СтрокаТаблицы.Ключ, "Ключ").Номенклатура;
			ИмяСписка = НСтр("ru = 'Данные по счетам-фактурам номенклатуры ""%1""'");
			ИмяСписка = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ИмяСписка, СвязаннаяНоменклатура);
			
			ТекстСообщения = ОбщегоНазначенияКлиентСервер.ТекстОшибкиЗаполнения("Колонка",, НСтр("ru = 'Способ учета НДС'"),
			СтрокаТаблицы.НомерСтрокиТЧ, ИмяСписка);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, ЭтотОбъект, Поле, "Объект", Отказ);	
			
		КонецЕсли;	
		
	КонецЦикла;
	
	ОбщегоНазначения.УдалитьНепроверяемыеРеквизитыИзМассива(ПроверяемыеРеквизиты, МассивНепроверяемыхРеквизитов);
	
КонецПроцедуры

Процедура ОбработкаУдаленияПроведения(Отказ)

	ПроведениеСервер.ПодготовитьНаборыЗаписейКОтменеПроведения(ЭтотОбъект);
	Движения.Записать();
	
	РаботаСПоследовательностями.ОтменитьРегистрациюВПоследовательности(ЭтотОбъект, Отказ);
	
КонецПроцедуры

Процедура ПриКопировании(ОбъектКопирования)

	Дата = НачалоДня(ОбщегоНазначения.ТекущаяДатаПользователя());
	Ответственный = Пользователи.ТекущийПользователь();
	
КонецПроцедуры

#КонецЕсли